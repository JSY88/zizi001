<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuizFlow - Smart Review</title>
  <style>
    :root { --primary: #2563eb; --danger: #ef4444; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --sub: #64748b; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
    
    body { background: var(--bg); color: var(--text); padding: 20px; max-width: 600px; margin: 0 auto; line-height: 1.5; padding-bottom: 80px; }
    
    /* ë²„íŠ¼ ê³µí†µ */
    .btn { padding: 8px 16px; border-radius: 8px; border: 1px solid #cbd5e1; background: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 4px; }
    .btn:hover { background: #f1f5f9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-icon { padding: 8px; color: var(--sub); border: none; background: transparent; border-radius: 50%; }
    .btn-icon:hover { color: var(--text); background: #f1f5f9; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }

    /* í† ê¸€ ìŠ¤ìœ„ì¹˜ (ì˜¤ë‹µ ë…¸íŠ¸) */
    .toggle-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
    .toggle-switch { position: relative; width: 44px; height: 24px; background: #cbd5e1; border-radius: 12px; transition: 0.3s; }
    .toggle-switch::after { content: ''; position: absolute; left: 2px; top: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .toggle-input:checked + .toggle-wrapper .toggle-switch { background: var(--danger); }
    .toggle-input:checked + .toggle-wrapper .toggle-switch::after { transform: translateX(20px); }
    .toggle-input { display: none; }
    .toggle-label { font-size: 14px; font-weight: 600; color: var(--sub); }
    .toggle-input:checked + .toggle-wrapper .toggle-label { color: var(--danger); }

    /* í—¤ë” & í†µê³„ */
    .header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-start; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card); padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-val { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: var(--sub); font-weight: 500; }

    /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
    .list-container { display: flex; flex-direction: column; gap: 12px; }
    .list-item { 
      background: var(--card); border-radius: 12px; padding: 16px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; 
      display: flex; align-items: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .list-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .list-item.selected { border-color: var(--primary); background: #eff6ff; }
    
    /* ì„ íƒ ëª¨ë“œ ì²´í¬ë°•ìŠ¤ */
    .select-check { margin-right: 12px; width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
    .list-item.selected .select-check { background: var(--primary); border-color: var(--primary); }
    .list-item.selected .select-check::after { content: 'âœ”'; color: white; font-size: 12px; }

    .item-info { flex: 1; min-width: 0; } /* min-width for text truncation */
    .item-info h3 { font-size: 16px; margin-bottom: 4px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-info p { font-size: 13px; color: var(--sub); }
    .item-actions { display: flex; gap: 4px; align-items: center; }

    /* ë¬¸ì œ í’€ê¸° í™”ë©´ */
    .quiz-card { background: var(--card); padding: 24px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-top: 10px; }
    .question-badge { display: inline-block; padding: 4px 12px; background: #f1f5f9; color: var(--sub); font-size: 12px; font-weight: 600; border-radius: 20px; margin-bottom: 12px; }
    .question-text { font-size: 19px; font-weight: 700; margin-bottom: 24px; line-height: 1.4; color: var(--text); }
    .option-btn { 
      display: block; width: 100%; text-align: left; padding: 16px; margin-bottom: 10px; 
      border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s;
    }
    .option-btn:hover { border-color: var(--primary); background: #f8fafc; }
    .option-btn:active { transform: scale(0.98); }
    .option-btn.correct { background: #dcfce7; border-color: #22c55e; color: #15803d; }
    .option-btn.wrong { background: #fee2e2; border-color: var(--danger); color: #b91c1c; }

    /* í•˜ë‹¨ í”Œë¡œíŒ… ë°” (ë³‘í•©ìš©) */
    .bottom-bar { 
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); 
      background: var(--text); color: white; padding: 12px 24px; border-radius: 50px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; gap: 16px; align-items: center; z-index: 50; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    .bottom-bar.active { transform: translateX(-50%) translateY(0); }

    /* ëª¨ë‹¬ */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(2px); }
    .modal.active { display: flex; }
    .modal-box { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
    .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    
    .empty-state { text-align: center; padding: 60px 0; color: #94a3b8; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="modal" class="modal"></div>

<script type="module">
  // 1. Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë²„ì „ 12.7.0)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // 2. ë‹˜ê»˜ì„œ ê°€ì ¸ì˜¤ì‹  Firebase ì„¤ì •ê°’ (ê·¸ëŒ€ë¡œ ì ìš©í•¨)
  const firebaseConfig = {
    apiKey: "AIzaSyDdHzcvkQMeJCNo6OZWrr06q1oMH5xvSiI",
    authDomain: "my-quiz-app-b5e97.firebaseapp.com",
    projectId: "my-quiz-app-b5e97",
    storageBucket: "my-quiz-app-b5e97.firebasestorage.app",
    messagingSenderId: "1095263157286",
    appId: "1:1095263157286:web:03e507d491423fcb9c3ae7",
    measurementId: "G-H4NGN70E5S"
  };

  // 3. ì•± ë° ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ======================
  // 4. ë°ì´í„° ì €ì¥ì†Œ ë¡œì§ (DB)
  // ======================
  
  // ì‚¬ìš©ì êµ¬ë¶„ í‚¤ (ë‹‰ë„¤ì„)
  let USER_KEY = localStorage.getItem('quiz_user_key');
  
  if (!USER_KEY) {
    USER_KEY = prompt("ë°ì´í„°ë¥¼ ê³µìœ í•  ë‚˜ë§Œì˜ ë‹‰ë„¤ì„(ID)ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: myname123)", "guest");
    if(!USER_KEY) USER_KEY = "guest";
    localStorage.setItem('quiz_user_key', USER_KEY);
  }

  // ì „ì—­ DB ê°ì²´
  window.DB = {
    data: {
      folders: [{ id: 'def', name: 'ê¸°ë³¸ í´ë”' }],
      quizzes: [],
      results: []
    },
    
    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì•± ì‹œì‘ ì‹œ 1íšŒ)
    async load() {
      try {
        // Firestoreì—ì„œ ë‚´ ë‹‰ë„¤ì„ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
        const docRef = doc(db, "quiz_users", USER_KEY);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          this.data = docSnap.data();
          console.log(`[${USER_KEY}] ë°ì´í„° ë¡œë“œ ì™„ë£Œ!`);
        } else {
          console.log("ìƒˆë¡œìš´ ì‚¬ìš©ìë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
          this.save(); // ì´ˆê¸° ë°ì´í„° ìƒì„±
        }
      } catch (e) {
        alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + e.message + "\n(í˜¹ì‹œ Firebase Consoleì—ì„œ 'Firestore Database'ë¥¼ ìƒì„±í•˜ì…¨ë‚˜ìš”?)");
      }
    },

    // ë°ì´í„° ì €ì¥í•˜ê¸° (ë³€ê²½ ì‹œë§ˆë‹¤)
    async save() {
      try {
        // Firestoreì— ë°ì´í„° ë®ì–´ì“°ê¸°
        await setDoc(doc(db, "quiz_users", USER_KEY), this.data);
        // í™”ë©´ ê°±ì‹ 
        if(window.App) window.App.render(); 
      } catch (e) {
        console.error("ì €ì¥ ì‹¤íŒ¨", e);
      }
    },

    // ì˜¤ë‹µ ì¸ë±ìŠ¤ ì¶”ì¶œ í•¨ìˆ˜
    getWrongIndices(quizId) {
      const lastResults = {};
      if(!this.data.results) return [];
      
      this.data.results
        .filter(r => r.quizId === quizId)
        .forEach(r => {
          if (!lastResults[r.qId] || lastResults[r.qId].date < r.date) {
            lastResults[r.qId] = r;
          }
        });
      
      return Object.values(lastResults)
        .filter(r => !r.correct)
        .map(r => r.qId);
    }
  };

  // ======================
  // 5. ì•± ë¡œì§ (App) - ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
  // ======================
  window.App = {
    state: {
      view: 'home',
      currentFolderId: null,
      currentQuiz: null,
      qIndex: 0,
      answers: [],
      reviewMode: false,
      selectMode: false,
      selectedQuizIds: []
    },

    goHome() {
      this.state.view = 'home';
      this.state.currentFolderId = null;
      this.state.selectMode = false;
      this.state.selectedQuizIds = [];
      this.render();
    },

    goToList(folderId) {
      this.state.view = 'list';
      this.state.currentFolderId = folderId;
      this.state.selectMode = false;
      this.state.selectedQuizIds = [];
      this.render();
    },

    startQuiz(quizId) {
      if (this.state.selectMode) return;
      const originalQuiz = window.DB.data.quizzes.find(q => q.id === quizId);
      if (!originalQuiz) return;

      let targetQuestions = originalQuiz.questions;
      let isFiltered = false;

      if (this.state.reviewMode) {
        const wrongIndices = window.DB.getWrongIndices(quizId);
        if (wrongIndices.length === 0) {
          alert("í‹€ë¦° ê¸°ë¡ì´ ìˆëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰");
          return;
        }
        targetQuestions = originalQuiz.questions
          .map((q, idx) => ({ ...q, _originalIndex: idx }))
          .filter(q => wrongIndices.includes(q._originalIndex));
        isFiltered = true;
      } else {
        targetQuestions = originalQuiz.questions.map((q, idx) => ({ ...q, _originalIndex: idx }));
      }

      this.state.currentQuiz = {
        ...originalQuiz,
        questions: targetQuestions,
        isFiltered
      };
      this.state.view = 'quiz';
      this.state.qIndex = 0;
      this.state.answers = [];
      this.render();
    },

    addFolder() {
      const name = prompt('ìƒˆ í´ë” ì´ë¦„:');
      if (!name) return;
      window.DB.data.folders.push({ id: Date.now().toString(), name });
      window.DB.save();
    },

    renameFolder(e, id) {
      e.stopPropagation();
      const folder = window.DB.data.folders.find(f => f.id === id);
      const name = prompt('í´ë” ì´ë¦„ ìˆ˜ì •:', folder.name);
      if (name) { folder.name = name; window.DB.save(); }
    },

    deleteFolder(e, id) {
      e.stopPropagation();
      if (!confirm('í´ë”ì™€ ë‚´ë¶€ í€´ì¦ˆê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;
      window.DB.data.folders = window.DB.data.folders.filter(f => f.id !== id);
      window.DB.data.quizzes = window.DB.data.quizzes.filter(q => q.folderId !== id);
      window.DB.save();
    },

    renameQuiz(e, quizId) {
      e.stopPropagation();
      const quiz = window.DB.data.quizzes.find(q => q.id === quizId);
      const name = prompt('í€´ì¦ˆ ì œëª© ìˆ˜ì •:', quiz.title);
      if (name) { quiz.title = name; window.DB.save(); }
    },

    deleteQuiz(e, id) {
      e.stopPropagation();
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      window.DB.data.quizzes = window.DB.data.quizzes.filter(q => q.id !== id);
      window.DB.save();
    },

    toggleSelectMode() {
      this.state.selectMode = !this.state.selectMode;
      this.state.selectedQuizIds = [];
      this.render();
    },

    toggleSelection(quizId) {
      const ids = this.state.selectedQuizIds;
      if (ids.includes(quizId)) {
        this.state.selectedQuizIds = ids.filter(id => id !== quizId);
      } else {
        this.state.selectedQuizIds.push(quizId);
      }
      this.render();
    },

    mergeSelectedQuizzes() {
      const ids = this.state.selectedQuizIds;
      if (ids.length < 2) { alert('2ê°œ ì´ìƒì˜ í€´ì¦ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

      const newName = prompt('ë³‘í•©ëœ í€´ì¦ˆì˜ ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ë³‘í•©ëœ í€´ì¦ˆ');
      if (!newName) return;

      const targetQuizzes = window.DB.data.quizzes.filter(q => ids.includes(q.id));
      let mergedQuestions = [];
      
      targetQuizzes.forEach(q => {
        mergedQuestions = [...mergedQuestions, ...q.questions];
      });

      const newQuiz = {
        id: Math.random().toString(36).substr(2, 9),
        folderId: this.state.currentFolderId,
        title: newName,
        questions: mergedQuestions
      };

      window.DB.data.quizzes.push(newQuiz);
      
      if (confirm('ë³‘í•© í›„ ì›ë³¸ í€´ì¦ˆë“¤ì€ ì‚­ì œí• ê¹Œìš”?')) {
        window.DB.data.quizzes = window.DB.data.quizzes.filter(q => !ids.includes(q.id));
      }

      this.state.selectMode = false;
      this.state.selectedQuizIds = [];
      window.DB.save();
    },

    addQuizModal() {
      const folders = window.DB.data.folders;
      const currentId = this.state.currentFolderId;
      
      const modalHtml = `
        <div class="modal-box">
          <h2 style="margin-bottom:16px; font-size:18px; font-weight:bold;">í€´ì¦ˆ ì¶”ê°€</h2>
          
          <div class="input-group">
            <label>ì €ì¥í•  í´ë”</label>
            <select id="m_folder" class="input-field">
              ${folders.map(f => `<option value="${f.id}" ${f.id === currentId ? 'selected' : ''}>${f.name}</option>`).join('')}
            </select>
          </div>

          <div class="input-group">
            <label>ì œëª©</label>
            <input id="m_title" type="text" class="input-field" placeholder="ì˜ˆ: ì˜ë‹¨ì–´ day1">
          </div>

          <div class="input-group">
            <label>í€´ì¦ˆ ë°ì´í„° (JSON)</label>
            <textarea id="m_json" class="input-field" style="height:120px; font-family:monospace;" placeholder='[{"q":"ì§ˆë¬¸","options":["A","B"],"correct":0}]'></textarea>
          </div>

          <div style="display:flex; gap:8px; margin-top:24px;">
            <button onclick="document.getElementById('modal').classList.remove('active')" class="btn" style="flex:1">ì·¨ì†Œ</button>
            <button onclick="window.App.saveQuizData()" class="btn btn-primary" style="flex:1">ì €ì¥</button>
          </div>
        </div>
      `;
      const modal = document.getElementById('modal');
      modal.innerHTML = modalHtml;
      modal.classList.add('active');
    },

    saveQuizData() {
      try {
        const folderId = document.getElementById('m_folder').value;
        const title = document.getElementById('m_title').value.trim();
        const jsonStr = document.getElementById('m_json').value;
        const data = JSON.parse(jsonStr);

        let newQuizzes = [];
        
        if (Array.isArray(data) && data[0].questions) {
          newQuizzes = data.map(q => ({
            id: Math.random().toString(36).substr(2, 9),
            folderId,
            title: q.title || title || 'ì œëª© ì—†ìŒ',
            questions: q.questions
          }));
        } else if (Array.isArray(data)) {
          if (!title) throw new Error("ë‹¨ì¼ í€´ì¦ˆëŠ” ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          newQuizzes.push({
            id: Math.random().toString(36).substr(2, 9),
            folderId,
            title,
            questions: data
          });
        } else {
          throw new Error("ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
        }

        window.DB.data.quizzes.push(...newQuizzes);
        window.DB.save();
        document.getElementById('modal').classList.remove('active');
        
      } catch (e) {
        alert('ë°ì´í„° ì˜¤ë¥˜: ' + e.message);
      }
    },

    selectAnswer(idx) {
      this.state.answers[this.state.qIndex] = idx;
      this.render();
    },

    nextQuestion() {
      const total = this.state.currentQuiz.questions.length;
      if (this.state.qIndex < total - 1) {
        this.state.qIndex++;
        this.render();
      } else {
        this.finishQuiz();
      }
    },

    finishQuiz() {
      const quiz = this.state.currentQuiz;
      const answers = this.state.answers;
      let correctCnt = 0;

      quiz.questions.forEach((q, i) => {
        const isCorrect = answers[i] === q.correct;
        if (isCorrect) correctCnt++;
        
        window.DB.data.results.push({
          quizId: quiz.id,
          qId: q._originalIndex,
          correct: isCorrect,
          date: Date.now()
        });
      });
      window.DB.save();

      alert(`ì™„ë£Œ! ì ìˆ˜: ${correctCnt} / ${quiz.questions.length}`);
      this.goToList(quiz.folderId);
    },

    toggleReviewModeState(e) {
      this.state.reviewMode = e.target.checked;
      this.render();
    },

    render() {
      const app = document.getElementById('app');
      const { view } = this.state;
      
      // DB ë¡œë“œ ì „ì´ë©´ ë¡œë”© í‘œì‹œ
      if (!window.DB || !window.DB.data) {
        app.innerHTML = '<div class="empty-state">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>';
        return;
      }

      if (view === 'home') app.innerHTML = this.viewHome();
      else if (view === 'list') app.innerHTML = this.viewList();
      else if (view === 'quiz') app.innerHTML = this.viewQuiz();
    },

    viewHome() {
      const folders = window.DB.data.folders;
      const quizzes = window.DB.data.quizzes;
      const results = window.DB.data.results || [];
      
      const totalSolved = results.length;
      const totalCorrect = results.filter(r => r.correct).length;
      const accuracy = totalSolved ? Math.round((totalCorrect/totalSolved)*100) : 0;

      return `
        <div class="header" style="flex-direction:column; align-items: flex-start;">
          <h1 style="font-size:26px; font-weight:800; color:var(--text);">QuizFlow</h1>
          <p style="color:var(--sub); margin-top:4px;">${USER_KEY}ë‹˜ì˜ í´ë¼ìš°ë“œ ì €ì¥ì†Œ â˜ï¸</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-val">${totalSolved}</div>
            <div class="stat-label">í‘¼ ë¬¸ì œ</div>
          </div>
          <div class="stat-card">
            <div class="stat-val">${totalCorrect}</div>
            <div class="stat-label">ì •ë‹µ</div>
          </div>
          <div class="stat-card">
            <div class="stat-val" style="color:${accuracy >= 80 ? '#22c55e' : accuracy >= 50 ? '#eab308' : '#ef4444'}">${accuracy}%</div>
            <div class="stat-label">ì •ë‹µë¥ </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:24px;">
          <button onclick="window.App.addQuizModal()" class="btn btn-primary" style="flex:1; padding:12px;">+ í€´ì¦ˆ ì¶”ê°€</button>
          <button onclick="window.App.addFolder()" class="btn" style="flex:1;">+ í´ë” ì¶”ê°€</button>
        </div>

        <div class="list-container">
          ${folders.length === 0 ? '<div class="empty-state">í´ë”ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>' : ''}
          ${folders.map(f => {
            const count = quizzes.filter(q => q.folderId === f.id).length;
            return `
              <div class="list-item" onclick="window.App.goToList('${f.id}')">
                <div class="item-info">
                  <h3>ğŸ“ ${f.name}</h3>
                  <p>í€´ì¦ˆ ${count}ê°œ</p>
                </div>
                <div class="item-actions">
                  <button onclick="window.App.renameFolder(event, '${f.id}')" class="btn-icon">âœ</button>
                  <button onclick="window.App.deleteFolder(event, '${f.id}')" class="btn-icon">ğŸ—‘</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    },

    viewList() {
      const fId = this.state.currentFolderId;
      const folder = window.DB.data.folders.find(f => f.id === fId);
      const folderQuizzes = window.DB.data.quizzes.filter(q => q.folderId === fId);
      const { reviewMode, selectMode, selectedQuizIds } = this.state;

      if (!folder) { this.goHome(); return ''; }

      return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <button onclick="window.App.goHome()" class="btn">â† ëª©ë¡</button>
          
          ${folderQuizzes.length > 0 ? `
            <button onclick="window.App.toggleSelectMode()" class="btn ${selectMode ? 'btn-primary' : ''}">
              ${selectMode ? 'ì™„ë£Œ' : 'ì„ íƒ'}
            </button>
          ` : ''}
        </div>
        
        <div class="header" style="align-items:flex-end;">
          <div>
            <h1 style="font-size:22px; font-weight:800;">${folder.name}</h1>
            <p style="color:var(--sub); font-size:14px;">ì´ ${folderQuizzes.length}ê°œì˜ í€´ì¦ˆ</p>
          </div>

           ${!selectMode ? `
            <div style="text-align:right;">
              <input type="checkbox" id="reviewToggle" class="toggle-input" ${reviewMode ? 'checked' : ''} onchange="window.App.toggleReviewModeState(event)">
              <label for="reviewToggle" class="toggle-wrapper">
                <span class="toggle-label" style="font-size:12px;">ì˜¤ë‹µ ë³µìŠµ</span>
                <div class="toggle-switch"></div>
              </label>
            </div>
          ` : ''}
        </div>

        ${folderQuizzes.length === 0 ? '<div class="empty-state">ë“±ë¡ëœ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>' : ''}

        <div class="list-container">
          ${folderQuizzes.map(q => {
            const isSelected = selectedQuizIds.includes(q.id);
            return `
              <div class="list-item ${selectMode && isSelected ? 'selected' : ''}" 
                   onclick="${selectMode ? `window.App.toggleSelection('${q.id}')` : `window.App.startQuiz('${q.id}')`}">
                
                ${selectMode ? `<div class="select-check"></div>` : ''}
                
                <div class="item-info">
                  <h3>ğŸ“ ${q.title}</h3>
                  <p>ë¬¸ì œ ${q.questions.length}ê°œ ${reviewMode ? '<span style="color:var(--danger); font-size:11px;">(ì˜¤ë‹µ ìš°ì„ )</span>' : ''}</p>
                </div>
                
                ${!selectMode ? `
                <div class="item-actions" onclick="event.stopPropagation()">
                  <button onclick="window.App.renameQuiz(event, '${q.id}')" class="btn-icon">âœ</button>
                  <button onclick="window.App.deleteQuiz(event, '${q.id}')" class="btn-icon">ğŸ—‘</button>
                </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>

        <div class="bottom-bar ${selectMode && selectedQuizIds.length > 0 ? 'active' : ''}">
          <span style="font-weight:600;">${selectedQuizIds.length}ê°œ ì„ íƒë¨</span>
          <button onclick="window.App.mergeSelectedQuizzes()" class="btn btn-primary" style="border:none;">ë³‘í•©í•˜ê¸°</button>
        </div>
      `;
    },

    viewQuiz() {
      const quiz = this.state.currentQuiz;
      const idx = this.state.qIndex;
      const question = quiz.questions[idx];
      const userAnswer = this.state.answers[idx];
      const isAnswered = userAnswer !== undefined;
      const progress = ((idx + 1) / quiz.questions.length) * 100;

      return `
        <div style="max-width:500px; margin:0 auto;">
          <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
            <button onclick="window.App.goToList('${quiz.folderId}')" class="btn">âœ•</button>
            <div style="font-weight:700; color:var(--primary);">
              ${quiz.isFiltered ? 'ğŸ”¥ ì˜¤ë‹µ ë³µìŠµ ì¤‘' : quiz.title}
            </div>
          </div>

          <div style="height:6px; background:#e2e8f0; border-radius:3px; margin-bottom:20px; overflow:hidden;">
            <div style="height:100%; background:var(--primary); width:${progress}%; transition:width 0.3s;"></div>
          </div>

          <div class="quiz-card">
            <span class="question-badge">Question ${idx + 1} / ${quiz.questions.length}</span>
            <h2 class="question-text">${question.q}</h2>
            
            <div style="display:flex; flex-direction:column; gap:8px;">
              ${question.options.map((opt, i) => {
                let statusClass = '';
                if (isAnswered) {
                  if (i === question.correct) statusClass = 'correct';
                  else if (i === userAnswer) statusClass = 'wrong';
                }
                return `
                  <button 
                    onclick="${!isAnswered ? `window.App.selectAnswer(${i})` : ''}" 
                    class="option-btn ${statusClass}"
                    ${isAnswered ? 'disabled' : ''}
                  >
                    ${opt}
                  </button>
                `;
              }).join('')}
            </div>

            ${isAnswered ? `
              <div style="margin-top:24px; padding-top:20px; border-top:1px solid #e2e8f0; animation: fadeIn 0.3s;">
                <p style="margin-bottom:12px; font-weight:800; font-size:18px; color:${userAnswer === question.correct ? '#15803d' : '#b91c1c'};">
                  ${userAnswer === question.correct ? 'ğŸ‰ ì •ë‹µ!' : 'ğŸ¤” ì•„ì‰½ë„¤ìš”.'}
                </p>
                ${question.explanation ? `<div style="font-size:14px; color:#475569; background:#f1f5f9; padding:12px; border-radius:8px; line-height:1.6;">ğŸ’¡ ${question.explanation}</div>` : ''}
                <button onclick="window.App.nextQuestion()" class="btn btn-primary" style="width:100%; margin-top:16px; padding:14px; font-size:16px;">
                  ${idx < quiz.questions.length - 1 ? 'ë‹¤ìŒ ë¬¸ì œ' : 'ê²°ê³¼ ë³´ê¸°'}
                </button>
              </div>
            ` : ''}
          </div>
        </div>
        <style>@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }</style>
      `;
    }
  };

  // ì•± ì‹¤í–‰
  window.addEventListener('DOMContentLoaded', async () => {
    await window.DB.load();
    window.App.render();
  });
</script>
</body>
</html>
